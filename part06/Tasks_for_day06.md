# Day 06 - Piscine SQL

## _Давайте улучшим качество обслуживания клиентов_

Резюме: Сегодня вы увидите, как добавить новую бизнес-функцию в нашу модель данных

## Rules of the day

- Наш способ получения знаний является постепенным и линейным, поэтому, пожалуйста, имейте в виду, что все изменения, которые вы внесли в День 03 во время упражнений 07-13, должны быть на месте (это похоже на то, что происходит в реальном мире, когда мы применяем релиз и должны быть согласованы с данными для новых изменений).

![schema](../materials/images/schema.png)


## Exercise 00 - Discounts, discounts , everyone loves discounts

| Exercise 00: Discounts, discounts , everyone loves discounts |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Turn-in directory                     | ex00                                                                                                                     |
| Files to turn-in                      | `day06_ex00.sql`                                                                                 |
| **Allowed**                               |                                                                                                                          |
| Language                        | SQL, DML, DDL                                                                                              |

Давайте расширим нашу модель данных, включив в нее новую функцию для бизнеса.
Каждый человек хочет получать персональную скидку, и каждый бизнес хочет быть ближе к клиентам.

Пожалуйста, подумайте о персональных скидках для посетителей, с одной стороны, и для ресторанов-пиццерий - с другой. Необходимо создать новую реляционную таблицу (пожалуйста, задайте имя `person_discounts`) со следующими правилами.
- установите атрибут id как первичный ключ (пожалуйста, посмотрите на столбец id в существующих таблицах и выберите тот же тип данных).
- установите для атрибутов person_id и pizzeria_id внешние ключи для соответствующих таблиц (типы данных должны быть такими же, как для столбцов id в соответствующих родительских таблицах).
- пожалуйста, задайте явные имена для ограничений внешних ключей по шаблону fk_{table_name}_{column_name}, например `fk_person_discounts_person_id`
- добавьте атрибут скидки, чтобы сохранить значение скидки в процентах. Помните, что величина скидки может быть числом с плавающей точкой (пожалуйста, просто используйте тип данных `numeric`). Поэтому, пожалуйста, выберите соответствующий тип данных, чтобы учесть эту возможность.

## Exercise 01 - Let’s set personal discounts

| Exercise 01: Let’s set personal discounts|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Turn-in directory                     | ex01                                                                                                                     |
| Files to turn-in                      | `day06_ex01.sql`                                                                                 |
| **Allowed**                               |                                                                                                                          |
| Language                        | SQL, DML, DDL                                                                                              |

На самом деле, мы создали структуру для хранения наших скидок, и мы готовы пойти дальше и заполнить нашу таблицу `person_discounts` новыми записями.

Итак, есть таблица `person_order`, в которой хранится история заказов пользователя. Пожалуйста, напишите инструкцию DML (`INSERT INTO ... SELECT ...`), которая вставляет новые записи в таблицу `person_discounts" на основе следующих правил.
- берем агрегированное состояние по столбцам person_id и pizzeria_id 
- рассчитать величину персональной скидки по следующему псевдокоду:

    `if “amount of orders” = 1 then
        “discount” = 10.5 
    else if “amount of orders” = 2 then 
        “discount” = 22
    else 
        “discount” = 30`

- чтобы сгенерировать первичный ключ для таблицы `person_discounts`, пожалуйста, используйте приведенную ниже конструкцию SQL (эта конструкция взята из области SQL WINDOW FUNCTION).
    
    `... ROW_NUMBER( ) OVER ( ) AS id ...`


## Exercise 02 - Let’s recalculate a history of orders

| Exercise 02: Let’s recalculate a history of orders|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Turn-in directory                     | ex02                                                                                                                     |
| Files to turn-in                      | `day06_ex02.sql`                                                                                 |
| **Allowed**                               |                                                                                                                          |
| Language                        | SQL, DML, DDL                                                                                              |

Пожалуйста, напишите SQL-запрос, который возвращает заказы с актуальной ценой и ценой с примененной скидкой для каждого человека в соответствующей пиццерии-ресторане и сортирует по имени человека и названию пиццы. Пожалуйста, взгляните на образец данных, приведенный ниже.

| name | pizza_name | price | discount_price | pizzeria_name | 
| ------ | ------ | ------ | ------ | ------ |
| Andrey | cheese pizza | 800 | 624 | Dominos |
| Andrey | mushroom pizza | 1100 | 858 | Dominos |
| ... | ... | ... | ... | ... |


## Exercise 03 - Improvements are in a way

| Exercise 03: Improvements are in a way |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Turn-in directory                     | ex03                                                                                                                     |
| Files to turn-in                      | `day06_ex03.sql`                                                                                 |
| **Allowed**                               |                                                                                                                          |
| Language                        | SQL, DML, DDL                                                                                              |


На самом деле, мы должны улучшить согласованность данных, с одной стороны, и настроить производительность - с другой. Пожалуйста, создайте уникальный индекс с несколькими столбцами (с именем `idx_person_discounts_unique`), который предотвращает дублирование парных значений идентификаторов персоны и пиццерии.

После создания нового индекса, пожалуйста, предоставьте любую простую инструкцию SQL, подтверждающую использование индекса (используя `EXPLAIN ANALYZE`).
Пример “доказательства” приведен ниже
    
    ...
    Index Scan using idx_person_discounts_unique on person_discounts
    ...


## Exercise 04 - We need more Data Consistency


| Exercise 04: We need more Data Consistency |                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Turn-in directory                     | ex04                                                                                                                     |
| Files to turn-in                      | `day06_ex04.sql`                                                                                 |
| **Allowed**                               |                                                                                                                          |
| Language                        | SQL, DML, DDL                                                                                              |

Пожалуйста, добавьте следующие правила ограничения для существующих столбцов таблицы `person_discounts`.
- person_id column should not be NULL (use constraint name `ch_nn_person_id`)
- pizzeria_id column should not be NULL (use constraint name `ch_nn_pizzeria_id`)
- discount column should not be NULL (use constraint name `ch_nn_discount`)
- discount column should be 0 percent by default
- discount column should be in a range values from 0 to 100 (use constraint name `ch_range_discount`)

## Exercise 05 - Data Governance Rules


| Exercise 05: Data Governance Rules|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Turn-in directory                     | ex05                                                                                                                     |
| Files to turn-in                      | `day06_ex05.sql`                                                                                 |
| **Allowed**                               |                                                                                                                          |
| Language                        |  SQL, DML, DDL                                                                                              |

Для соблюдения политик управления данными необходимо добавить комментарии к таблице и ее столбцам. Давайте применим эту политику к таблице `person_discounts`. Пожалуйста, добавьте комментарии на английском или русском языках (это зависит от вас), которые объясняют, какова бизнес-цель таблицы и все включенные атрибуты.

## Exercise 06 - Let’s automate Primary Key generation


| Exercise 06: Let’s automate Primary Key generation|                                                                                                                          |
|---------------------------------------|--------------------------------------------------------------------------------------------------------------------------|
| Turn-in directory                     | ex06                                                                                                                     |
| Files to turn-in                      | `day06_ex06.sql`                                                                                 |
| **Allowed**                               |                                                                                                                          |
| Language                        | SQL, DML, DDL                                                                                              |
| **Denied**                               |                                                                                                                          |
| SQL Syntax Pattern                        | Don’t use hard-coded value for amount of rows to set a right value for sequence                                                                                              |

Давайте создадим последовательность данных с именем `seq_person_discounts` (начиная со значения 1) и установим значение по умолчанию для атрибута id таблицы `person_discounts`, чтобы каждый раз автоматически получать значение из `seq_person_discounts`. 
Пожалуйста, имейте в виду, что ваш следующий порядковый номер равен 1, в этом случае, пожалуйста, установите фактическое значение для последовательности базы данных, основанное на формуле “количество строк в таблице person_discounts” + 1. В противном случае вы получите сообщение об ошибке, связанной с нарушением ограничения первичного ключа.

[Вернуться в README.md](../README.md)